- content_for :extra_javascript do
  = javascript_include_tag "http://maps.google.com/maps/api/js?sensor=true"
  = javascript_include_tag "http://code.google.com/apis/gears/gears_init.js"

- content_for :extra_javascript do
  :javascript
    var initialLocation;
    var map;
    var helsinki = new google.maps.LatLng(60.2, 24.9);
    var browserSupportFlag =  new Boolean();

    function initialize() {
      var myOptions = {
        zoom: 10,
        mapTypeId: google.maps.MapTypeId.ROADMAP
      };
      map = new google.maps.Map(document.getElementById("map-canvas"), myOptions);
      
      // Try W3C Geolocation (Preferred)
      if(navigator.geolocation) {
        browserSupportFlag = true;
        navigator.geolocation.getCurrentPosition(function(position) {
          initialLocation = new google.maps.LatLng(position.coords.latitude,position.coords.longitude);
          map.setCenter(initialLocation);
        }, function() {
          handleNoGeolocation(browserSupportFlag);
        });
      // Try Google Gears Geolocation
      } else if (google.gears) {
        browserSupportFlag = true;
        var geo = google.gears.factory.create('beta.geolocation');
        geo.getCurrentPosition(function(position) {
          initialLocation = new google.maps.LatLng(position.latitude,position.longitude);
          map.setCenter(initialLocation);
        }, function() {
          handleNoGeoLocation(browserSupportFlag);
        });
      // Browser doesn't support Geolocation
      } else {
        browserSupportFlag = false;
        handleNoGeolocation(browserSupportFlag);
      }
      
      function handleNoGeolocation(errorFlag) {
        if (errorFlag == true) {
          alert("Geolocation service failed.");
          initialLocation = helsinki;
        } else {
          alert("Your browser doesn't support geolocation. We've placed you in Helsinki.");
          initialLocation = helsinki;
        }
        map.setCenter(initialLocation);
      }
      google.maps.event.addListenerOnce(map, 'tilesloaded', addListingMarkers);
    }
    
    
    function addListingMarkers() {
      // The following two statements had Ruby evaluations, but they did not with the current implementation
      //var lat = Location.first.latitude;
      //var lng = Location.first.longitude;
      var lat = 60.1863;
      var lng = 24.8279;
      var location = new google.maps.LatLng(lat, lng)
      
      var marker = new google.maps.Marker({
        position: location,
        map: map
      });
    }

    google.maps.event.addDomListener(window, 'load', initialize);

#map-canvas{:style => "width: 100%; height: 500px"}

